Windows10/11 にRISC-Vのクロスコンパイル環境を構築する方法の解説ページです。
手順は以下の通りです。

* WSL2のUbuntuを導入する
* Ubuntuに`apt`で`gcc-riscv64-unknown-elf`をインストールする

### WSL2の導入

Windows環境にUbuntuをインストールしていきます。

まず管理者権限でPowerShellを起動し、以下のように`wsl --list --online`と入力して実行します。

01  
![ ](top/01.png)

以下のようにインストール可能なLinuxディストリビューションが一覧表示されます。
`*`マークの付いているもの (今回はUbuntu) が標準でインストールされます。

02  
![ ](top/02.png)

Ubuntuをインストールするため、以下のように`wsl --install`と入力して実行して下さい。
明示的にUbuntuを指定する場合は`wsl --install -d Ubuntu`とします。

03  
![ ](top/03.png)

以下のように表示されれば成功です。
指示に従い、Windowsを再起動して下さい。

04  
![ ](top/04.png)

再起動後、以下のように自動でUbuntuのコンソール(黒い画面)が立ち上がります。
もし自動で起動しなければ、WindowsスタートボタンからUbuntuを選んで実行して下さい。

05  
![ ](top/05.png)

以下のようにUbuntuで使用するユーザー名とパスワードを適当に設定して下さい。

06  
![ ](top/06.png)


ユーザーが作成されると、以下のように表示されます。

07  
![ ](top/07.png)

パッケージを更新するため、`sudo apt update`と入力して実行して下さい。

08  
![ ](top/08.png)

パッケージが無事に更新できれば、以下のように表示されます。

09  
![ ](top/09.png)

### クロスコンパイラの導入

C言語やアセンブラで書かれたコードを、RISC-Vの機械語バイナリに変換するためのクロスコンパイラを導入します。

まずUbuntuで`sudo apt install gcc-riscv64-unknown-elf`と入力して実行します。

10  
![ ](top/10.png)

本当にインストールするか尋ねられるので、`Y`と入力します。

11  
![ ](top/11.png)

クロスコンパイラのインストールに成功すれば、以下のように表示されます。

12  
![ ](top/12.png)

以上の工程により

* `riscv64-unknown-elf-gcc`
* `riscv64-unknown-elf-objcopy`
* `riscv64-unknown-elf-objcopy`

といったコマンドが使用可能になりました。

ちなみに32bitの機械語を出力するための、`riscv32-unknown-elf-gcc`というコマンドは用意されていません。
なぜなら`riscv64-unknown-elf-gcc`の実行時に`-march=rv32i`というオプションを付けることで、32bitの機械語バイナリが出力できるからです。
コマンド名は`riscv64-...`ですが、その中身は32bitと64bitの両対応版だと思って下さい。

### クロスコンパイラの使い方

動作確認を兼ねて、クロスコンパイラの使い方を見ていきます。
まずサンプルコードをダウンロードし、解凍して下さい。

すると以下の4つのファイルが得られます。
このフォルダパスを確認して下さい。

13  
![ ](top/13.png)

次にUbuntuを立ち上げて、先ほど確認したフォルダパスに移動します。
以下のように`cd`コマンドを実行して下さい。

14  
![ ](top/14.png)

無事に移動できれば、以下のように表示されます。

15  
![ ](top/15.png)

チェックのため、以下のように`ls`コマンドを実行して下さい。

* `compile.sh`
* `func.c`
* `linker.ld`
* `start.s`

の4つのファイルが確認できればOKです。

16  
![ ](top/16.png)

いよいよコンパイルを実行してみます。
以下のように`sh compile.sh`を実行して下さい。

17  
![ ](top/17.png)

うまく実行できれば、以下のようにエラーメッセージが表示されません。

18  
![ ](top/18.png)

コンパイルして得られたファイルを確認してみます。
以下のように`ls`コマンドを実行し、`a.bin`や`a.list`が表示されればOKです。

19  
![ ](top/19.png)

こうして得られたファイルは、Windowsのエクスプローラーからアクセスできます。
特に以下の`a.bin`というファイルはベタイメージと呼ばれています。

20  
![ ](top/20.png)

ベタイメージの`a.bin`は、元々の

* `func.c`
* `linker.ld`
* `start.s`

という3つのファイルをそのまま機械語に変換したものです。
他の余計な情報(ELFヘッダ)は一切含まれていません。
OS無しでプログラムを走らせるには、このベタイメージを使用します。
